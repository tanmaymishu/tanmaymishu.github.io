<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>The Anatomy of Laravel's tap() Function - Tanmay's Website</title><meta name=Description content="This is my cool site"><meta property="og:title" content="The Anatomy of Laravel's tap() Function"><meta property="og:description" content="If there is one thing I really like about the Laravel PHP Framework, it would be its level of code sophistication, whether it is in something as complex as the ORM or even in something as simple as a helper function. The latter is what this article is about.
Laravel has a Ruby-inspired, higher-order function called tap(). In a nutshell, the tap helper function takes a value and a callback; passes the value to the callback and returns the value."><meta property="og:type" content="article"><meta property="og:url" content="https://tanmaymishu.github.io/posts/the-anatomy-of-laravels-tap-function/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-05-31T19:14:40+06:00"><meta property="article:modified_time" content="2019-05-31T19:14:40+06:00"><meta property="og:site_name" content="My cool site"><meta name=twitter:card content="summary"><meta name=twitter:title content="The Anatomy of Laravel's tap() Function"><meta name=twitter:description content="If there is one thing I really like about the Laravel PHP Framework, it would be its level of code sophistication, whether it is in something as complex as the ORM or even in something as simple as a helper function. The latter is what this article is about.
Laravel has a Ruby-inspired, higher-order function called tap(). In a nutshell, the tap helper function takes a value and a callback; passes the value to the callback and returns the value."><meta name=application-name content="My cool site"><meta name=apple-mobile-web-app-title content="My cool site"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://tanmaymishu.github.io/posts/the-anatomy-of-laravels-tap-function/><link rel=next href=https://tanmaymishu.github.io/posts/undocumented-laravel-macros/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"The Anatomy of Laravel's tap() Function","inLanguage":"en-us","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/tanmaymishu.github.io\/posts\/the-anatomy-of-laravels-tap-function\/"},"genre":"posts","keywords":"metaprogramming","wordcount":1338,"url":"https:\/\/tanmaymishu.github.io\/posts\/the-anatomy-of-laravels-tap-function\/","datePublished":"2019-05-31T19:14:40+06:00","dateModified":"2019-05-31T19:14:40+06:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Tanmay"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Tanmay's Website">&lt;TANMAY/></a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=/uses/>Uses </a><a class=menu-item href=/about/>About </a><a class=menu-item href=/portfolio/>Portfolio </a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Tanmay's Website">&lt;TANMAY/></a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=/uses/ title>Uses</a><a class=menu-item href=/about/ title>About</a><a class=menu-item href=/portfolio/ title>Portfolio</a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">The Anatomy of Laravel's tap() Function</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Tanmay</a></span>&nbsp;<span class=post-category>included in <a href=/categories/laravel/><i class="far fa-folder fa-fw" aria-hidden=true></i>laravel</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2019-05-31>2019-05-31</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;1338 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;7 minutes&nbsp;</div></div><div class="details toc" id=toc-static data-kept><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents></nav></div></div><div class=content id=content><p>If there is one thing I really like about the Laravel PHP Framework, it would be its level of code sophistication, whether it is in something as complex as the ORM or even in something as simple as a helper function. The latter is what this article is about.</p><p>Laravel has a Ruby-inspired, higher-order function called <code>tap()</code>. In a nutshell, the tap helper function takes a value and a callback; passes the value to the callback and returns the value. Let&rsquo;s take a look at how we could implement such a function from scratch in PHP:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>function</span> <span style=color:#06287e>tap</span>(<span style=color:#bb60d5>$value</span>, <span style=color:#bb60d5>$callback</span>) {
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>$callback</span>(<span style=color:#bb60d5>$value</span>);
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> <span style=color:#bb60d5>$value</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The function takes two arguments:</p><ol><li>A value, <code>$value</code></li><li>A callback function, <code>$callback</code></li></ol><p>As you can see, inside the function&rsquo;s body, the $value is passed as the argument to the callback function and after the invocation of $callback, the $value is returned from the tap() function.</p><p>Even though the function looks extremely simple, it opens the door to many possibilities. When I saw this function for the first time, I was like, why would someone even want to use that?!</p><p>We&rsquo;ve all come across this very common 3-step situation:</p><ul><li>We create a new variable by calling a function that returns a value, instantiating a class or any expression that evaluates to some value. e.g. <code>$foo = bar();</code>, <code>$foo = new Bar;</code>, <code>$foo = 40+2;</code>.</li><li>Then we do something with that variable. e.g. <code>$foo->calculatePrice();</code></li><li>Eventually, we return that variable. return <code>$foo;</code></li></ul><p>An example should make more sense:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#bb60d5>$person</span> <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>new</span> <span style=color:#007020;font-weight:700>stdClass</span>;
</span></span><span style=display:flex><span><span style=color:#bb60d5>$person</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>name</span> <span style=color:#666>=</span> <span style=color:#4070a0>&#39;John&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>return</span> <span style=color:#bb60d5>$person</span>;
</span></span></code></pre></div><p>The tap function allows us to simplify the example in one statement, like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>return</span> tap(<span style=color:#007020;font-weight:700>new</span> <span style=color:#007020;font-weight:700>stdClass</span>, <span style=color:#007020;font-weight:700>function</span>(<span style=color:#bb60d5>$person</span>) {
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>$person</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>name</span> <span style=color:#666>=</span> <span style=color:#4070a0>&#39;John&#39;</span>;
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>Here, we pass an instance of PHP&rsquo;s built-in, generic <code>stdClass</code> class as our value and also the callback function which will act upon that value(instance of <code>stdClass</code>). Inside the callback, we simply assign a string &lsquo;John&rsquo; to the $person&rsquo;s name property.</p><p>Since the tap function always returns the first argument, <code>$value</code>, we can immediately access the members of that <code>$value</code> (new <code>stdClass</code>). So in our case, if we wanted to instantiate a class, set a value to its property and then echo out the value of that property, we could do that all in a single statement:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>echo</span> tap(<span style=color:#007020;font-weight:700>new</span> <span style=color:#007020;font-weight:700>stdClass</span>, <span style=color:#007020;font-weight:700>function</span>(<span style=color:#bb60d5>$person</span>) {
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>$person</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>name</span> <span style=color:#666>=</span> <span style=color:#4070a0>&#39;Jane&#39;</span>;
</span></span><span style=display:flex><span>})<span style=color:#666>-&gt;</span><span style=color:#4070a0>name</span>; <span style=color:#60a0b0;font-style:italic>// Jane
</span></span></span></code></pre></div><p>Again, without the tap function, the above example would take the shape of this:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#bb60d5>$person</span> <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>new</span> <span style=color:#007020;font-weight:700>stdClass</span>;
</span></span><span style=display:flex><span><span style=color:#bb60d5>$person</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>name</span> <span style=color:#666>=</span> <span style=color:#4070a0>&#39;Jane&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>echo</span> <span style=color:#bb60d5>$person</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>name</span>; <span style=color:#60a0b0;font-style:italic>// Jane
</span></span></span></code></pre></div><p>We can also take this tapping mechanism a bit further. What if we wanted to make the callback function optional? What if all we really want is to call a method of $value and just get the $value in return, instead of what the called method actually returns?</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#bb60d5>$person</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>setName</span>(<span style=color:#4070a0>&#39;John&#39;</span>); <span style=color:#60a0b0;font-style:italic>// --&gt; returns &#39;Done&#39;.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// For some reason we want to ignore the returned value &#39;Done&#39;:
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>tap(<span style=color:#bb60d5>$person</span>)<span style=color:#666>-&gt;</span><span style=color:#4070a0>setName</span>(<span style=color:#4070a0>&#39;John&#39;</span>); <span style=color:#60a0b0;font-style:italic>// --&gt; returns $person.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic>// Notice the No. of arguments in tap(). No callback.
</span></span></span></code></pre></div><p>Here, <code>setName()</code> is a method of the $person object. We called the <code>setName()</code> method but in that process, we also disregarded <code>setName()</code>&rsquo;s actual return value (The not-so-useful string &ldquo;Done&rdquo;) and returned the $person instead. Confused? Let&rsquo;s take a look at a real-world scenario and then we&rsquo;ll update our implementation of <code>tap()</code>.</p><p>Say we have a method named <code>addToWallet()</code> in our User model:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>public</span> <span style=color:#007020;font-weight:700>function</span> <span style=color:#06287e>addToWallet</span>(<span style=color:#bb60d5>$amount</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> (<span style=color:#bb60d5>$amount</span> <span style=color:#666>&lt;</span> <span style=color:#40a070>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020;font-weight:700>false</span>;
</span></span><span style=display:flex><span>    } <span style=color:#007020;font-weight:700>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#bb60d5>$this</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>wallet</span>()<span style=color:#666>-&gt;</span><span style=color:#4070a0>increment</span>(<span style=color:#4070a0>&#39;balance&#39;</span>, <span style=color:#bb60d5>$amount</span>);
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020;font-weight:700>true</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>…as you can see if we call the method on <code>$user</code> object like this: <code>$user->addToWallet(50);</code> it will, of course, return a boolean. Let&rsquo;s say in addition to updating the user&rsquo;s wallet, we also need to return the <code>$user</code> from some controller&rsquo;s action. It would take two statements to achieve that:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>public</span> <span style=color:#007020;font-weight:700>function</span> <span style=color:#06287e>update</span>(Request <span style=color:#bb60d5>$request</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#60a0b0;font-style:italic>// Validation logic skipped for brevity
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>$user</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>addToWallet</span>(<span style=color:#bb60d5>$request</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>amount</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> <span style=color:#bb60d5>$user</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>But we want something like this one-liner:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#007020;font-weight:700>return</span> tap(<span style=color:#bb60d5>$user</span>)<span style=color:#666>-&gt;</span><span style=color:#4070a0>addToWallet</span>(<span style=color:#bb60d5>$request</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>amount</span>); <span style=color:#60a0b0;font-style:italic>// $user
</span></span></span></code></pre></div><p>To achieve that we will have to enhance our current implementation of <code>tap()</code>. Let&rsquo;s start by making the callback optional first with the default parameter:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>function</span> <span style=color:#06287e>tap</span>(<span style=color:#bb60d5>$value</span>, <span style=color:#bb60d5>$callback</span> <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>$callback</span>(<span style=color:#bb60d5>$value</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> <span style=color:#bb60d5>$value</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now comes the tricky part. We&rsquo;ve said that when no callback is passed to the tap (<code>tap($user)</code>), we would like to return the given value (<code>$user</code>) from the called method(<code>->addToWallet(50)</code>) instead of what the called method actually returns.</p><p>How can we enforce the method (<code>addToWallet()</code>) to return the value (<code>$user</code>), when in its definition, it returns a completely different thing (true/false) than the value?</p><p>PHP has a magic method called <code>__call()</code> which, if implemented in a class, is invoked &ldquo;automagically&rdquo; whenever we try to call a non-existent method on an object of that class. We just have to pass the <code>$value</code> (which from now on I will also call the <code>$target</code>) to the constructor of a class that implements <code>__call()</code>. Let&rsquo;s call that class <code>TapWithoutCallback</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>TapWithoutCallback</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>public</span> <span style=color:#bb60d5>$target</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>public</span> <span style=color:#007020;font-weight:700>function</span> __construct(<span style=color:#bb60d5>$target</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#bb60d5>$this</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>target</span> <span style=color:#666>=</span> <span style=color:#bb60d5>$target</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>public</span> <span style=color:#007020;font-weight:700>function</span> __call(<span style=color:#bb60d5>$method</span>, <span style=color:#bb60d5>$parameters</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>// Calls the method on the value/target.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>        <span style=color:#60a0b0;font-style:italic>// $this-&gt;user-&gt;addToWallet(50);
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>        <span style=color:#bb60d5>$this</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>target</span><span style=color:#666>-&gt;</span>{<span style=color:#bb60d5>$method</span>}(…<span style=color:#bb60d5>$parameters</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#60a0b0;font-style:italic>// Returns the value/target.
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>        <span style=color:#60a0b0;font-style:italic>// $this-&gt;user;
</span></span></span><span style=display:flex><span><span style=color:#60a0b0;font-style:italic></span>        <span style=color:#007020;font-weight:700>return</span> <span style=color:#bb60d5>$this</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>target</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>If we create an instance of this <code>TapWithoutCallback</code> class and try to access a method that doesn&rsquo;t exist there, it will delegate the method call (line 16) to the target/value that we passed during the instantiation.</p><p>As an improvement to our <code>tap()</code> function, now all we have to do is return an instance of the <code>TapWithoutCallback</code> class when no callback is passed. The finished version of our tap function looks like this:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>function</span> <span style=color:#06287e>tap</span>(<span style=color:#bb60d5>$value</span>, <span style=color:#bb60d5>$callback</span> <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>null</span>) {
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> (is_null(<span style=color:#bb60d5>$callback</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020;font-weight:700>new</span> TapWithoutCallback(<span style=color:#bb60d5>$value</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>$callback</span>(<span style=color:#bb60d5>$value</span>);
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> <span style=color:#bb60d5>$value</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Now, if we don&rsquo;t pass a callback, it will return an instance of <code>TapWithoutCallback</code>(line 5) instead of returning the original <code>$value</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>tap(<span style=color:#bb60d5>$user</span>);
</span></span></code></pre></div><p>If we try to call the method <code>addToWallet()</code> on it:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span>tap(<span style=color:#bb60d5>$user</span>)<span style=color:#666>-&gt;</span><span style=color:#4070a0>addToWallet</span>();
</span></span></code></pre></div><p>…which doesn&rsquo;t exist on the instance that <code>tap()</code> has returned (<code>new TapWithoutCallback</code>), PHP will summon its <code>__call</code> magic method which will call the <code>addToWallet()</code> on behalf of the target/value (<code>$user</code>) and then return the <code>$user</code> (TapWithoutCallback.php:16-20).</p><p>Finally, we can clean up our controller&rsquo;s action:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>public</span> <span style=color:#007020;font-weight:700>function</span> <span style=color:#06287e>update</span>(Request <span style=color:#bb60d5>$request</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> tap(<span style=color:#bb60d5>$user</span>)<span style=color:#666>-&gt;</span><span style=color:#4070a0>addToWallet</span>(<span style=color:#bb60d5>$request</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>amount</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Interestingly, we can even chain another method of User model, since whatever method we call on the model&rsquo;s instance, is going to return the same instance, regardless of what the method&rsquo;s actual return value is. So, this is possible:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span>tap(<span style=color:#bb60d5>$user</span>)<span style=color:#666>-&gt;</span><span style=color:#4070a0>addToWallet</span>(<span style=color:#bb60d5>$request</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>amount</span>)
</span></span><span style=display:flex><span>          <span style=color:#666>-&gt;</span><span style=color:#4070a0>notify</span>(<span style=color:#007020;font-weight:700>new</span> WalletUpdated);
</span></span></code></pre></div><p>But now we&rsquo;ve lost the ability to return the <code>$user</code> from <code>notify()</code>, since <code>notify()</code> is no longer being called on the tap&rsquo;s returned instance. It is now being called directly on <code>$user</code>. To mitigate this problem, we can stack the tap calls like this (pay close attention to the parentheses):</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>return</span> tap(tap(<span style=color:#bb60d5>$user</span>)<span style=color:#666>-&gt;</span><span style=color:#4070a0>addToWallet</span>(<span style=color:#bb60d5>$request</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>amount</span>))
</span></span><span style=display:flex><span>                     <span style=color:#666>-&gt;</span><span style=color:#4070a0>notify</span>(<span style=color:#007020;font-weight:700>new</span> WalletUpdated);
</span></span></code></pre></div><p><code>notify()</code> will now return the tapped value, which is the <code>$user</code>. Think of the above example as two layers of Inception.</p><p>Another use case will be Laravel&rsquo;s <code>update()</code> method, which also returns a boolean. We can leverage the <code>tap()</code> function to explicitly return the model, instead of the boolean:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>return</span> tap(<span style=color:#bb60d5>$post</span>)<span style=color:#666>-&gt;</span><span style=color:#4070a0>update</span>([
</span></span><span style=display:flex><span>    <span style=color:#4070a0>&#39;title&#39;</span> <span style=color:#666>=&gt;</span> <span style=color:#bb60d5>$title</span>,
</span></span><span style=display:flex><span>    <span style=color:#4070a0>&#39;description&#39;</span> <span style=color:#666>=&gt;</span> <span style=color:#bb60d5>$description</span>,
</span></span><span style=display:flex><span>]); <span style=color:#60a0b0;font-style:italic>// $post
</span></span></span></code></pre></div><p>Here is the <code>tap()</code> function that Laravel implements:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic> * Call the given Closure with the given value then return the value.
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic> *
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic> * @param  mixed  $value
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic> * @param  callable|null  $callback
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic> * @return mixed
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic> */</span>
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>function</span> <span style=color:#06287e>tap</span>(<span style=color:#bb60d5>$value</span>, <span style=color:#bb60d5>$callback</span> <span style=color:#666>=</span> <span style=color:#007020;font-weight:700>null</span>)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>if</span> (is_null(<span style=color:#bb60d5>$callback</span>)) {
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> <span style=color:#007020;font-weight:700>new</span> HigherOrderTapProxy(<span style=color:#bb60d5>$value</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#bb60d5>$callback</span>(<span style=color:#bb60d5>$value</span>);
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>return</span> <span style=color:#bb60d5>$value</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Here, <code>HigherOrderTapProxy</code> is our <code>TapWithoutCallback</code>-equivalent class. Laravel&rsquo;s <code>HigherOrderTapProxy</code> class:</p><div class=highlight><pre tabindex=0 style=background-color:#f0f0f0;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#666>&lt;?</span>php
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>namespace</span> Illuminate\Support;
</span></span><span style=display:flex><span><span style=color:#007020;font-weight:700>class</span> <span style=color:#0e84b5;font-weight:700>HigherOrderTapProxy</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#4070a0;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic>     * The target being tapped.
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic>     * @var mixed
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>public</span> <span style=color:#bb60d5>$target</span>;
</span></span><span style=display:flex><span>    <span style=color:#4070a0;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic>     * Create a new tap proxy instance.
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic>     * @param  mixed  $target
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic>     * @return void
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>public</span> <span style=color:#007020;font-weight:700>function</span> __construct(<span style=color:#bb60d5>$target</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#bb60d5>$this</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>target</span> <span style=color:#666>=</span> <span style=color:#bb60d5>$target</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#4070a0;font-style:italic>/**
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic>     * Dynamically pass method calls to the target.
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic>     *
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic>     * @param  string  $method
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic>     * @param  array  $parameters
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic>     * @return mixed
</span></span></span><span style=display:flex><span><span style=color:#4070a0;font-style:italic>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#007020;font-weight:700>public</span> <span style=color:#007020;font-weight:700>function</span> __call(<span style=color:#bb60d5>$method</span>, <span style=color:#bb60d5>$parameters</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#bb60d5>$this</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>target</span><span style=color:#666>-&gt;</span>{<span style=color:#bb60d5>$method</span>}(<span style=color:#666>...</span><span style=color:#bb60d5>$parameters</span>);
</span></span><span style=display:flex><span>        <span style=color:#007020;font-weight:700>return</span> <span style=color:#bb60d5>$this</span><span style=color:#666>-&gt;</span><span style=color:#4070a0>target</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Got any questions? Leave a comment.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2019-05-31</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://tanmaymishu.github.io/posts/the-anatomy-of-laravels-tap-function/ data-title="The Anatomy of Laravel's tap() Function" data-via=@tanmaymishu data-hashtags=metaprogramming><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://tanmaymishu.github.io/posts/the-anatomy-of-laravels-tap-function/ data-hashtag=metaprogramming><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://tanmaymishu.github.io/posts/the-anatomy-of-laravels-tap-function/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on WhatsApp" data-sharer=whatsapp data-url=https://tanmaymishu.github.io/posts/the-anatomy-of-laravels-tap-function/ data-title="The Anatomy of Laravel's tap() Function" data-web><i class="fab fa-whatsapp fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Hacker News" data-sharer=hackernews data-url=https://tanmaymishu.github.io/posts/the-anatomy-of-laravels-tap-function/ data-title="The Anatomy of Laravel's tap() Function"><i class="fab fa-hacker-news fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Reddit" data-sharer=reddit data-url=https://tanmaymishu.github.io/posts/the-anatomy-of-laravels-tap-function/><i class="fab fa-reddit fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/metaprogramming/>metaprogramming</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/posts/undocumented-laravel-macros/ class=next rel=next title="Undocumented Laravel: Macros">Undocumented Laravel: Macros<i class="fas fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=utterances class=comment></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://utteranc.es/>utterances</a>.</noscript></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line>Tanmay's Website</div><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>Tanmay</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{utterances:{darkTheme:"github-dark",issueTerm:"title",label:"comment",lightTheme:"github-light",repo:"tanmaymishu/tanmaymishu.github.io"}}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>